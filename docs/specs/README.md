# 機能仕様書の書き方

このドキュメントでは、機能仕様書を書くためのガイドラインを説明します。

## 基本方針

### 1. コードを書かない
仕様書には具体的なコード例を記載しません。
実装と仕様が乖離するリスクを避けるためです。

**❌ 避けるべき:**
```typescript
function login(email: string, password: string) {
  // ...実装コード
}
```

**✅ 推奨:**
```
ログイン機能は、メールアドレスとパスワードを受け取り、
認証に成功した場合はユーザー情報とトークンを返します。
認証に失敗した場合はエラーを返します。
```

### 2. データフローは図や自然言語で表現
データの流れは、フローチャートや自然言語で説明します。

**例: ログインフロー**
```
1. ユーザーがメールアドレスとパスワードを入力
2. システムが入力値をバリデーション
   - 失敗 → エラーメッセージを表示
3. データベースでユーザーを検索
   - 見つからない → 「ユーザーが存在しません」エラー
4. パスワードを検証
   - 不一致 → 「パスワードが間違っています」エラー
5. JWTトークンを生成
6. ユーザー情報とトークンを返却
```

### 3. 「何を」実現するかに集中
「どのように」実装するかではなく、「何を」実現するかを記述します。

## 仕様書のテンプレート

`templates/feature-spec.md` を使用してください。

## 記載すべき内容

### 1. 概要
機能の目的と背景を簡潔に説明します。

### 2. 要件
- 機能要件: 何ができるべきか
- 非機能要件: パフォーマンス、セキュリティなど

### 3. ユースケース
主要なユースケースをシナリオ形式で記載します。

### 4. データモデル
エンティティとその関係を説明します（コードではなく説明文や図で）。

### 5. 画面・UI（該当する場合）
画面の構成要素と動作を説明します。

### 6. ビジネスロジック
重要なビジネスルールを明記します。

### 7. エラーハンドリング
想定されるエラーケースと対応を記載します。

### 8. 制約事項
技術的制約や前提条件を明記します。

## 良い仕様書の例

### ✅ 良い例: ユーザー認証機能

**概要**
ユーザーがシステムにログインし、安全にアクセスできるようにします。

**機能要件**
- メールアドレスとパスワードでログインできる
- ログイン成功時にJWTトークンを発行する
- トークンの有効期限は24時間とする
- ログイン失敗時は適切なエラーメッセージを表示する

**ユースケース**
1. 正常ログイン
   - ユーザーが正しい認証情報を入力
   - システムがトークンを発行
   - ダッシュボードにリダイレクト

2. ログイン失敗
   - ユーザーが誤った認証情報を入力
   - システムがエラーメッセージを表示
   - ログイン画面を再表示

**データフロー**
```
[ログイン画面]
    ↓ 入力: email, password
[バリデーション]
    ↓ OK
[データベース検索]
    ↓ ユーザー情報取得
[パスワード検証]
    ↓ OK
[トークン生成]
    ↓
[レスポンス: user, token]
```

**エラーケース**
- メールアドレスが未入力: "メールアドレスを入力してください"
- ユーザーが存在しない: "認証情報が正しくありません"
- パスワードが不一致: "認証情報が正しくありません"

**セキュリティ要件**
- パスワードはハッシュ化して保存
- ログイン失敗時も処理時間を一定にする（タイミング攻撃対策）
- 連続ログイン失敗時はアカウントをロックする（5回失敗で15分ロック）

---

### ❌ 悪い例

**概要**
ログイン機能を作る

**実装**
```typescript
// ← コードを書いている（NG）
async function login(req, res) {
  const user = await User.findOne({ email: req.body.email })
  // ...
}
```

## 注意事項

- 実装の詳細は記載しない
- 使用する技術スタックは記載しない（アーキテクチャドキュメントに記載）
- 「〜する」という表現で要件を明確にする
- 曖昧な表現を避ける

## 仕様書作成のチェックリスト

- [ ] 機能の目的が明確
- [ ] 具体的なコードが含まれていない
- [ ] データフローが図や自然言語で説明されている
- [ ] エラーケースが網羅されている
- [ ] セキュリティ要件が考慮されている
- [ ] テスト可能な要件になっている
- [ ] 曖昧な表現がない

## 参考資料

- Architecture Decision Records: `docs/adr/`
- アーキテクチャ概要: `docs/architecture/overview.md`
- 用語集: `docs/rules/terminology.md`
