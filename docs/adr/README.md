# Architecture Decision Records (ADR)

## ADR とは

Architecture Decision Record (ADR) は、ソフトウェアアーキテクチャに関する重要な設計決定を記録するドキュメントです。

## なぜ ADR が必要か

1. **意思決定の透明性**: なぜその技術や設計を選んだかを明確にする
2. **知識の共有**: 新しいメンバーが過去の決定を理解できる
3. **再評価の基準**: 状況が変わったときに見直す基準となる
4. **同じ議論の繰り返し防止**: 過去に議論したことを記録

## ADR を書くべきタイミング

以下のような重要な決定をする際に ADR を作成します:

- **技術スタックの選択**: フレームワーク、ライブラリ、データベースなど
- **アーキテクチャパターン**: マイクロサービス、モノリス、レイヤードなど
- **重要なツール**: CI/CD、監視、ログ管理など
- **設計パターン**: 認証方式、API設計、状態管理など
- **インフラ**: クラウドプロバイダー、コンテナ化など

## ADR の書き方

### ファイル名の規則

```
NNNN-タイトル.md

例:
0001-use-postgresql.md
0002-adopt-microservices.md
0003-implement-jwt-auth.md
```

- NNNN: 4桁の連番（0001から開始）
- タイトル: kebab-case で簡潔に

### テンプレート

`templates/adr.md` をコピーして使用します。

```markdown
# [番号]. [決定のタイトル]

日付: YYYY-MM-DD
ステータス: [提案中 / 承認済み / 却下 / 非推奨 / 置き換え済み]

## コンテキスト

[決定が必要になった背景や問題を説明]

## 検討した選択肢

### 選択肢1: [名前]
- メリット:
  - ...
- デメリット:
  - ...

### 選択肢2: [名前]
- メリット:
  - ...
- デメリット:
  - ...

## 決定

[選択した選択肢とその理由]

## 結果

[この決定による影響や期待される結果]

## 参考資料

- [関連ドキュメントやリンク]
```

## 実例

### 例1: データベースの選択

```markdown
# 0001. PostgreSQL をデータベースとして採用

日付: 2025-01-08
ステータス: 承認済み

## コンテキスト

アプリケーションのデータ永続化のため、データベースを選択する必要がある。
要件として以下がある:
- トランザクション処理が必要
- JSON データの保存
- 全文検索機能
- 将来的なスケーリング

## 検討した選択肢

### 選択肢1: PostgreSQL
- メリット:
  - ACIDトランザクション対応
  - JSON/JSONB型のネイティブサポート
  - 全文検索機能が組み込み
  - 豊富なエクステンション
  - オープンソース
- デメリット:
  - セットアップが MySQL より複雑
  - 小規模なデータでは MySQL より遅い場合がある

### 選択肢2: MySQL
- メリット:
  - シンプルでセットアップが簡単
  - 軽量で高速（小規模データ）
  - ホスティングオプションが豊富
- デメリット:
  - JSON サポートが弱い
  - 全文検索が限定的

### 選択肢3: MongoDB
- メリット:
  - スキーマレス
  - JSON ネイティブ
  - 水平スケーリングが容易
- デメリット:
  - ACID トランザクションが弱い
  - 結合クエリが苦手
  - データ整合性の管理が難しい

## 決定

PostgreSQL を採用する。

理由:
1. ACID トランザクションが必須要件
2. JSONB 型で柔軟なデータ構造も扱える
3. 全文検索が組み込みで利用可能
4. コミュニティが活発で情報が豊富
5. PostGIS など拡張機能が豊富

## 結果

- データの整合性が保証される
- JSON データも効率的に扱える
- 全文検索機能が利用可能
- 学習コストは若干あるが、長期的には柔軟性が高い

## 参考資料

- [PostgreSQL公式ドキュメント](https://www.postgresql.org/docs/)
- [PostgreSQL vs MySQL](https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-vs-mysql/)
```

### 例2: 認証方式の選択

```markdown
# 0002. JWT トークン認証を採用

日付: 2025-01-08
ステータス: 承認済み

## コンテキスト

API の認証方式を決定する必要がある。
要件:
- RESTful API
- モバイルアプリとWebアプリの両方をサポート
- スケーラブルであること

## 検討した選択肢

### 選択肢1: セッションベース認証
- メリット:
  - サーバー側でセッション管理が可能
  - セッションの無効化が容易
- デメリット:
  - ステートフル（スケーリングが困難）
  - セッションストアが必要
  - モバイルアプリとの相性が悪い

### 選択肢2: JWT トークン認証
- メリット:
  - ステートレス（スケーリングが容易）
  - モバイルアプリと相性が良い
  - クロスドメインで利用可能
- デメリット:
  - トークンの無効化が困難
  - トークンサイズが大きい

## 決定

JWT トークン認証を採用する。

実装方針:
- アクセストークン: 短期間（1時間）
- リフレッシュトークン: 長期間（30日）
- リフレッシュトークンはデータベースで管理し、無効化可能にする

## 結果

- ステートレスなAPI設計が可能
- 水平スケーリングが容易
- モバイルアプリでも利用可能
- リフレッシュトークンで無効化の問題を解決

## 参考資料

- [JWT.io](https://jwt.io/)
- [セッション vs JWT](https://blog.bearer.sh/session-vs-jwt/)
```

## ADR のステータス

- **提案中**: まだ決定していない
- **承認済み**: 決定し、実装中または実装済み
- **却下**: 検討したが採用しない
- **非推奨**: 過去は有効だったが、現在は推奨しない
- **置き換え済み**: 別の ADR によって置き換えられた

### ステータスの更新

決定が変わった場合、古い ADR を更新します:

```markdown
# 0001. PostgreSQL をデータベースとして採用

日付: 2025-01-08
ステータス: 置き換え済み (0005-migrate-to-mongodb.md により)

...
```

そして新しい ADR を作成:

```markdown
# 0005. MongoDB への移行

日付: 2025-06-15
ステータス: 承認済み

## コンテキスト

要件の変更により、スキーマレスなデータベースが必要になった。
ADR 0001 で PostgreSQL を選択したが、以下の理由で再検討する:

...
```

## ベストプラクティス

### 簡潔に書く

- ADR は2〜3ページ程度に収める
- 詳細な実装は別のドキュメントに記載

### 客観的に書く

- メリット・デメリットを公平に記載
- 感情的な表現を避ける

### タイムリーに書く

- 決定した直後に書く
- 記憶が鮮明なうちに記録

### チームで議論

- ADR は個人ではなくチームで決定
- レビューを受けてから承認

## ADR の管理

### 一覧の更新

このREADMEの下部に、すべてのADRのリストを維持します:

| 番号 | タイトル | ステータス | 日付 |
|------|---------|-----------|------|
| 0001 | PostgreSQL を採用 | 承認済み | 2025-01-08 |
| 0002 | JWT 認証を採用 | 承認済み | 2025-01-08 |

### レビュープロセス

1. ADR をドラフト作成
2. チームでレビュー
3. 議論・修正
4. 承認
5. Git にコミット

## 参考資料

- [Documenting Architecture Decisions](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions)
- [ADR GitHub](https://adr.github.io/)
- [ADR Tools](https://github.com/npryce/adr-tools)

---

## ADR 一覧

| 番号 | タイトル | ステータス | 日付 |
|------|---------|-----------|------|
| - | - | - | - |

*プロジェクト開始時にADRを追加してください*
