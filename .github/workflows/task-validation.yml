# ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# æ©Ÿèƒ½:
#   - ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
#   - Issue æœªç™»éŒ²ã‚¿ã‚¹ã‚¯ã®æ¤œçŸ¥
#   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è‡ªå‹•æ›´æ–°

name: Task Validation

on:
  push:
    paths:
      - '.claude/tasks/**'
      - '.claude/dashboard.md'
  pull_request:
    paths:
      - '.claude/tasks/**'
  workflow_dispatch:

jobs:
  validate-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          gh --version

      - name: Validate task files
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..."

          ERRORS=()
          WARNINGS=()

          # backlog å†…ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -d ".claude/tasks/backlog" ]; then
            for file in .claude/tasks/backlog/*.md 2>/dev/null; do
              [ -f "$file" ] || continue
              task_id=$(basename "$file" .md)

              # Issue ç•ªå·ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if ! grep -q "GitHub Issue.*#[0-9]" "$file"; then
                WARNINGS+=("âš ï¸  ${task_id}: GitHub Issue ãŒæœªç™»éŒ²")
              fi

              # ã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if ! grep -q "^# " "$file"; then
                ERRORS+=("âŒ ${task_id}: ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ# ã§å§‹ã¾ã‚‹è¡Œï¼‰ãŒã‚ã‚Šã¾ã›ã‚“")
              fi
            done
          fi

          # in-progress å†…ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -d ".claude/tasks/in-progress" ]; then
            for instance_dir in .claude/tasks/in-progress/*/; do
              [ -d "$instance_dir" ] || continue
              for file in ${instance_dir}*.md 2>/dev/null; do
                [ -f "$file" ] || continue
                task_id=$(basename "$file" .md)

                # Issue ç•ªå·ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆin-progress ã§ã¯å¿…é ˆï¼‰
                if ! grep -q "GitHub Issue.*#[0-9]" "$file"; then
                  ERRORS+=("âŒ ${task_id}: å®Ÿè£…ä¸­ã‚¿ã‚¹ã‚¯ã« GitHub Issue ãŒæœªç™»éŒ²")
                fi
              done
            done
          fi

          # review å†…ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -d ".claude/tasks/review" ]; then
            for file in .claude/tasks/review/*.md 2>/dev/null; do
              [ -f "$file" ] || continue
              task_id=$(basename "$file" .md)

              # Issue ç•ªå·ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆreview ã§ã¯å¿…é ˆï¼‰
              if ! grep -q "GitHub Issue.*#[0-9]" "$file"; then
                ERRORS+=("âŒ ${task_id}: ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã‚¿ã‚¹ã‚¯ã« GitHub Issue ãŒæœªç™»éŒ²")
              fi
            done
          fi

          # çµæžœã‚’å‡ºåŠ›
          echo ""
          echo "========================================"
          echo "æ¤œè¨¼çµæžœ"
          echo "========================================"

          if [ ${#WARNINGS[@]} -gt 0 ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Š:"
            for warning in "${WARNINGS[@]}"; do
              echo "  $warning"
            done
          fi

          if [ ${#ERRORS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ã‚¨ãƒ©ãƒ¼:"
            for error in "${ERRORS[@]}"; do
              echo "  $error"
            done
            echo ""
            echo "has_errors=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo ""
            echo "âœ… ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ‰åŠ¹ã§ã™"
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Count tasks
        run: |
          echo "ðŸ“Š ã‚¿ã‚¹ã‚¯é›†è¨ˆ"
          echo "========================================"

          backlog=$(find .claude/tasks/backlog -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          in_progress=$(find .claude/tasks/in-progress -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          review=$(find .claude/tasks/review -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          completed=$(find .claude/tasks/completed -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          total=$((backlog + in_progress + review + completed))

          echo "æœªç€æ‰‹:     ${backlog}"
          echo "å®Ÿè£…ä¸­:     ${in_progress}"
          echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­: ${review}"
          echo "å®Œäº†:       ${completed}"
          echo "------------------------"
          echo "åˆè¨ˆ:       ${total}"

  update-dashboard:
    runs-on: ubuntu-latest
    needs: validate-tasks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update dashboard
        run: |
          chmod +x scripts/update-dashboard.sh
          ./scripts/update-dashboard.sh

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet .claude/dashboard.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit dashboard update
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .claude/dashboard.md
          git commit -m "[chore] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è‡ªå‹•æ›´æ–°"
          git push
