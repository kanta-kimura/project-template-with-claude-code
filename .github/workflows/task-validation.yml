# ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨: ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
# GitHub ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ GitHub Issues ã‚’ç›´æ¥ä½¿ç”¨

name: Task Validation

on:
  push:
    paths:
      - '.claude/tasks/**'
  pull_request:
    paths:
      - '.claude/tasks/**'
  workflow_dispatch:

jobs:
  validate-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate task files
        run: |
          echo "ğŸ” ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..."

          ERRORS=()
          WARNINGS=()

          # ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          for file in .claude/tasks/TASK-*.md 2>/dev/null; do
            [ -f "$file" ] || continue
            task_id=$(basename "$file" .md)

            # YAML front matter ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! head -1 "$file" | grep -q "^---"; then
              ERRORS+=("âŒ ${task_id}: YAML front matter ãŒã‚ã‚Šã¾ã›ã‚“")
              continue
            fi

            # status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! grep -q "^status:" "$file"; then
              ERRORS+=("âŒ ${task_id}: status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“")
            fi

            # ã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! grep -q "^# " "$file"; then
              ERRORS+=("âŒ ${task_id}: ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ# ã§å§‹ã¾ã‚‹è¡Œï¼‰ãŒã‚ã‚Šã¾ã›ã‚“")
            fi
          done

          # çµæœã‚’å‡ºåŠ›
          echo ""
          echo "========================================"
          echo "æ¤œè¨¼çµæœ"
          echo "========================================"

          if [ ${#WARNINGS[@]} -gt 0 ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Š:"
            for warning in "${WARNINGS[@]}"; do
              echo "  $warning"
            done
          fi

          if [ ${#ERRORS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ã‚¨ãƒ©ãƒ¼:"
            for error in "${ERRORS[@]}"; do
              echo "  $error"
            done
            exit 1
          else
            echo ""
            echo "âœ… ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ‰åŠ¹ã§ã™"
          fi

      - name: Count tasks
        run: |
          echo "ğŸ“Š ã‚¿ã‚¹ã‚¯é›†è¨ˆ"
          echo "========================================"

          backlog=0
          in_progress=0
          review=0
          completed=0

          for file in .claude/tasks/TASK-*.md 2>/dev/null; do
            [ -f "$file" ] || continue
            status=$(grep "^status:" "$file" | awk '{print $2}')
            case "$status" in
              backlog) backlog=$((backlog + 1)) ;;
              in-progress) in_progress=$((in_progress + 1)) ;;
              review) review=$((review + 1)) ;;
              completed) completed=$((completed + 1)) ;;
            esac
          done

          total=$((backlog + in_progress + review + completed))

          echo "æœªç€æ‰‹:     ${backlog}"
          echo "å®Ÿè£…ä¸­:     ${in_progress}"
          echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­: ${review}"
          echo "å®Œäº†:       ${completed}"
          echo "------------------------"
          echo "åˆè¨ˆ:       ${total}"
